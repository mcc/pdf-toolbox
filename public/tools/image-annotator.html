<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Annotator</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        #container {
            display: flex;
        }
        #left-column {
            flex: 3;
            margin-right: 20px;
        }
        #right-column {
            flex: 1;
        }
        #canvas-container {
            position: relative;
            display: inline-block;
            margin-top: 25px;
            margin-left: 25px;
        }
        #canvas {
            border: 1px solid black;
            cursor: crosshair;
        }
        #ruler-x, #ruler-y {
            position: absolute;
            background-color: #f0f0f0;
        }
        #ruler-x {
            top: -25px;
            left: 0;
            height: 25px;
        }
        #ruler-y {
            top: 0;
            left: -25px;
            width: 25px;
        }
        #coords {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            pointer-events: none;
        }
        #controls, #annotations-list {
            text-align: left;
            margin-bottom: 20px;
        }
        input, button {
            padding: 10px;
            font-size: 16px;
            margin: 5px;
            width: 100%;
            box-sizing: border-box;
        }
        #annotations-ul {
            list-style-type: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <h1>Image Annotator</h1>
    <div id="container">
        <div id="left-column">
            <div id="canvas-container">
                <canvas id="ruler-x"></canvas>
                <canvas id="ruler-y"></canvas>
                <canvas id="canvas"></canvas>
                <div id="coords" style="display: none;">x: 0, y: 0</div>
            </div>
        </div>
        <div id="right-column">
            <div id="controls">
                <h2>Controls</h2>
                <input type="file" id="image-loader" accept="image/*">
                <input type="number" id="width-input" placeholder="Width">
                <input type="number" id="height-input" placeholder="Height">
                <button id="resize-button">Resize</button>
                <input type="text" id="annotation-input" placeholder="[x, y, w, h, name]">
                <button id="add-annotation-button">Add Annotation</button>
            </div>
            <div id="annotations-list">
                <h2>Annotations</h2>
                <ul id="annotations-ul"></ul>
            </div>
        </div>
    </div>

    <script>
        const imageLoader = document.getElementById('image-loader');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const rulerXCanvas = document.getElementById('ruler-x');
        const rulerXCtx = rulerXCanvas.getContext('2d');
        const rulerYCanvas = document.getElementById('ruler-y');
        const rulerYCtx = rulerYCanvas.getContext('2d');
        const coordsDiv = document.getElementById('coords');
        const annotationsUl = document.getElementById('annotations-ul');
        const widthInput = document.getElementById('width-input');
        const heightInput = document.getElementById('height-input');
        const resizeButton = document.getElementById('resize-button');
        const annotationInput = document.getElementById('annotation-input');
        const addAnnotationButton = document.getElementById('add-annotation-button');

        let currentImage = null;
        let isDrawing = false;
        let startX, startY;
        let annotations = [];

        function drawRulers() {
            rulerXCanvas.width = canvas.width;
            rulerXCanvas.height = 25;
            rulerYCanvas.width = 25;
            rulerYCanvas.height = canvas.height;

            rulerXCtx.clearRect(0, 0, rulerXCanvas.width, rulerXCanvas.height);
            rulerYCtx.clearRect(0, 0, rulerYCanvas.width, rulerYCanvas.height);

            rulerXCtx.fillStyle = 'black';
            rulerYCtx.fillStyle = 'black';
            rulerXCtx.font = '10px Arial';
            rulerYCtx.font = '10px Arial';

            for (let x = 0; x < canvas.width; x += 10) {
                rulerXCtx.beginPath();
                rulerXCtx.moveTo(x, x % 50 === 0 ? 15 : 20);
                rulerXCtx.lineTo(x, 25);
                rulerXCtx.stroke();
                if (x % 50 === 0) {
                    rulerXCtx.fillText(x, x + 2, 12);
                }
            }

            for (let y = 0; y < canvas.height; y += 10) {
                rulerYCtx.beginPath();
                rulerYCtx.moveTo(y % 50 === 0 ? 15 : 20, y);
                rulerYCtx.lineTo(25, y);
                rulerYCtx.stroke();
                if (y % 50 === 0) {
                    rulerYCtx.save();
                    rulerYCtx.translate(12, y + 2);
                    rulerYCtx.rotate(-Math.PI / 2);
                    rulerYCtx.fillText(y, 0, 0);
                    rulerYCtx.restore();
                }
            }
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (currentImage) {
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            }
            drawAnnotations();
        }

        function drawAnnotations() {
            annotations.forEach(rect => {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
                if (rect.name) {
                    ctx.fillStyle = 'red';
                    ctx.font = '16px Arial';
                    ctx.fillText(rect.name, rect.x, rect.y - 5);
                }
            });
        }

        function updateAnnotationsList() {
            annotationsUl.innerHTML = '';
            annotations.forEach((rect, index) => {
                const li = document.createElement('li');
                li.textContent = `${rect.name}: [${rect.x}, ${rect.y}, ${rect.w}, ${rect.h}]`;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.style.width = 'auto'; // Override the global button width
                deleteBtn.onclick = () => {
                    annotations.splice(index, 1);
                    updateAnnotationsList();
                    redrawCanvas();
                };
                li.appendChild(deleteBtn);
                annotationsUl.appendChild(li);
            });
        }

        imageLoader.addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    widthInput.value = img.width;
                    heightInput.value = img.height;
                    currentImage = img;
                    drawRulers();
                    redrawCanvas();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        resizeButton.addEventListener('click', () => {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);

            if (width > 0 && height > 0) {
                canvas.width = width;
                canvas.height = height;
                drawRulers();
                redrawCanvas();
            } else {
                alert('Please enter valid dimensions.');
            }
        });

        addAnnotationButton.addEventListener('click', () => {
            const annotationText = annotationInput.value.trim();
            if (annotationText.startsWith('[') && annotationText.endsWith(']')) {
                const content = annotationText.slice(1, -1);
                const lastCommaIndex = content.lastIndexOf(',');
                if (lastCommaIndex !== -1) {
                    const coordsStr = content.slice(0, lastCommaIndex);
                    let name = content.slice(lastCommaIndex + 1).trim();
                    if (name.startsWith('"') && name.endsWith('"')) {
                        name = name.slice(1, -1);
                    }

                    try {
                        const coords = JSON.parse(`[${coordsStr}]`);
                        if (Array.isArray(coords) && coords.length === 4 && coords.every(n => typeof n === 'number')) {
                            const [x, y, w, h] = coords;
                            annotations.push({ x, y, w, h, name: name || `Annotation ${annotations.length + 1}` });
                            updateAnnotationsList();
                            redrawCanvas();
                            annotationInput.value = '';
                        } else {
                            throw new Error('Invalid coordinate format.');
                        }
                    } catch (error) {
                        alert('Invalid annotation format. Please use [x, y, w, h, "name"].');
                    }
                } else {
                    alert('Invalid annotation format. Name is missing.');
                }
            } else {
                alert('Invalid annotation format. Must start with [ and end with ].');
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.round(e.clientX - rect.left);
            const y = Math.round(e.clientY - rect.top);

            coordsDiv.style.left = `${e.clientX + 15}px`;
            coordsDiv.style.top = `${e.clientY + 15}px`;
            coordsDiv.textContent = `x: ${x}, y: ${y}`;

            if (isDrawing) {
                redrawCanvas();
                const endX = x;
                const endY = y;
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.strokeRect(startX, startY, endX - startX, endY - startY);
            }
        });

        canvas.addEventListener('mouseenter', () => {
            coordsDiv.style.display = 'block';
        });

        canvas.addEventListener('mouseleave', () => {
            coordsDiv.style.display = 'none';
        });

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            startX = Math.round(e.clientX - rect.left);
            startY = Math.round(e.clientY - rect.top);
            isDrawing = true;
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isDrawing) {
                isDrawing = false;
                const rect = canvas.getBoundingClientRect();
                const endX = Math.round(e.clientX - rect.left);
                const endY = Math.round(e.clientY - rect.top);

                const newRect = {
                    x: Math.min(startX, endX),
                    y: Math.min(startY, endY),
                    w: Math.abs(endX - startX),
                    h: Math.abs(endY - startY),
                    name: `Annotation ${annotations.length + 1}`
                };

                if (newRect.w > 0 && newRect.h > 0) {
                    annotations.push(newRect);
                }

                updateAnnotationsList();
                redrawCanvas();
            }
        });
    </script>
</body>
</html>
