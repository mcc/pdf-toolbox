<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巴士到站儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-4">
        <div class="flex-1">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800" id="title">巴士到站儀表板</h1>
                <div class="flex gap-2">
                    <button id="langToggle" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">English</button>
                    <button id="editToggle" class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">編輯</button>
                </div>
            </div>

            <div class="mb-6 flex flex-col sm:flex-row gap-4">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="搜索路線或地點" 
                    class="flex-grow p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <select 
                    id="profileSelect" 
                    class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="default">默認配置文件</option>
                </select>
                <button 
                    onclick="saveProfile()" 
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                    保存配置文件
                </button>
                <button 
                    onclick="shareDashboard()" 
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                >
                    分享
                </button>
            </div>

            <div id="searchResults" class="mb-6"></div>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4"></div>
        </div>
        
        <div class="lg:w-1/3 lg:flex-shrink-0 hidden lg:block">
            <div id="map" class="h-[600px] w-full sticky top-4"></div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
    <script>
        let map, selectedStops = [], markers = [], infoWindow;
        const API_BASE = 'https://data.etabus.gov.hk/v1/transport/kmb/';
        let routesData = [], stopsData = [];
        let isChinese = true, isEditMode = false;

        // Language toggle
        document.getElementById('langToggle').addEventListener('click', () => {
            isChinese = !isChinese;
            document.getElementById('langToggle').textContent = isChinese ? 'English' : '中文';
            document.getElementById('title').textContent = isChinese ? '巴士到站儀表板' : 'Bus Arrival Dashboard';
            document.getElementById('searchInput').placeholder = isChinese ? '搜索路線或地點' : 'Search route or location';
            document.getElementById('editToggle').textContent = isChinese ? '編輯' : 'Edit';
            updateDashboard();
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value) searchInput.dispatchEvent(new Event('input'));
        });

        // Edit mode toggle
        document.getElementById('editToggle').addEventListener('click', () => {
            isEditMode = !isEditMode;
            document.getElementById('editToggle').textContent = isEditMode ? (isChinese ? '完成' : 'Done') : (isChinese ? '編輯' : 'Edit');
            updateDashboard();
        });

        // Preload data
        async function preloadData() {
            try {
                const [routesRes, stopsRes] = await Promise.all([
                    fetch(`${API_BASE}route/`),
                    fetch(`${API_BASE}stop/`)
                ]);
                routesData = (await routesRes.json()).data;
                stopsData = (await stopsRes.json()).data;
            } catch (error) {
                console.error('Error preloading data:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await preloadData();
            initMap();
            loadProfiles();
            loadFromUrl();
            updateDashboard();
            setInterval(updateDashboard, 30000);
        });

        // Map initialization
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 22.3193, lng: 114.1694},
                zoom: 12
            });
            infoWindow = new google.maps.InfoWindow();
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                clearMarkers();
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';

            const matchingRoutes = routesData.filter(route => 
                route.route.toLowerCase().includes(query.toLowerCase())
            );
            
            if (matchingRoutes.length > 0) {
                showRouteResults(matchingRoutes);
                return;
            }

            showMapForLocation(query);
        });

        function showRouteResults(routes) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">${isChinese ? '匹配路線' : 'Matching Routes'}</h3>
                        <button 
                            onclick="closeResults()" 
                            class="text-red-500 hover:text-red-700"
                        >
                            ${isChinese ? '關閉' : 'Close'}
                        </button>
                    </div>
                    ${routes.map(route => `
                        <div 
                            class="py-2 border-b route-row"
                            onmouseover="highlightRouteStop('${route.route}', '${route.bound}')"
                            onmouseout="clearHighlight()"
                        >
                            <button 
                                onclick="showStopsForRoute('${route.route}', '${route.bound}')"
                                class="w-full text-left hover:bg-gray-100 p-2 rounded"
                            >
                                ${route.route} (${route.bound === 'O' ? (isChinese ? '出城' : 'Outbound') : (isChinese ? '入城' : 'Inbound')}) 
                                - ${isChinese ? route.dest_tc : route.dest_en}
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function showStopsForRoute(route, bound) {
            const direction = bound === 'O' ? 'outbound' : 'inbound';
            const res = await fetch(`${API_BASE}route-stop/${route}/${direction}/1`);
            const data = await res.json();
            const stops = data.data;
            
            clearMarkers();
            stops.forEach(stop => {
                const stopInfo = stopsData.find(s => s.stop === stop.stop);
                if (stopInfo) {
                    const marker = new google.maps.Marker({
                        position: {lat: parseFloat(stopInfo.lat), lng: parseFloat(stopInfo.long)},
                        map: map,
                        title: isChinese ? stopInfo.name_tc : stopInfo.name_en
                    });
                    markers.push(marker);
                }
            });
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(m => bounds.extend(m.getPosition()));
                map.fitBounds(bounds);
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">${isChinese ? `路線 ${route} 的巴士站` : `Stops for ${route}`}</h3>
                        <button 
                            onclick="closeResults()" 
                            class="text-red-500 hover:text-red-700"
                        >
                            ${isChinese ? '關閉' : 'Close'}
                        </button>
                    </div>
                    ${stops.map(stop => {
                        const stopInfo = stopsData.find(s => s.stop === stop.stop);
                        return `
                            <div 
                                class="py-2 border-b stop-row"
                                onmouseover="highlightStop('${stop.stop}')"
                                onmouseout="clearHighlight()"
                            >
                                <button 
                                    onclick="addToDashboard('${route}', '${stop.stop}', '${direction}')"
                                    class="w-full text-left hover:bg-gray-100 p-2 rounded"
                                >
                                    ${isChinese ? stopInfo?.name_tc : stopInfo?.name_en}
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function highlightRouteStop(route, bound) {
            // Already shown in map when stops are displayed
        }

        function highlightStop(stopId) {
            const stopInfo = stopsData.find(s => s.stop === stopId);
            if (!stopInfo) return;

            const marker = markers.find(m => m.getTitle() === (isChinese ? stopInfo.name_tc : stopInfo.name_en));
            if (marker) {
                map.panTo(marker.getPosition());
                infoWindow.setContent(isChinese ? stopInfo.name_tc : stopInfo.name_en);
                infoWindow.open(map, marker);
            }
        }

        function clearHighlight() {
            infoWindow.close();
        }

        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
        }

        function closeResults() {
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchInput').value = '';
            clearMarkers();
        }

        function showMapForLocation(query) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: query }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    
                    google.maps.event.addListenerOnce(map, 'click', async (e) => {
                        const clickedLatLng = e.latLng;
                        const nearbyStops = findNearbyStops(clickedLatLng);
                        showNearbyStopOptions(nearbyStops, clickedLatLng);
                    });
                }
            });
        }

        function findNearbyStops(latLng) {
            return stopsData.filter(stop => {
                const dist = getDistance(latLng.lat(), latLng.lng(), 
                    parseFloat(stop.lat), parseFloat(stop.long));
                return dist <= 1;
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function showNearbyStopOptions(stops, latLng) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">${isChinese ? '附近巴士站' : 'Nearby Stops'}</h3>
                        <button 
                            onclick="closeResults()" 
                            class="text-red-500 hover:text-red-700"
                        >
                            ${isChinese ? '關閉' : 'Close'}
                        </button>
                    </div>
                    ${stops.map(stop => `
                        <div class="py-2 border-b">
                            <button 
                                onclick="showRoutesForStop('${stop.stop}')"
                                class="w-full text-left hover:bg-gray-100 p-2 rounded"
                            >
                                ${isChinese ? stop.name_tc : stop.name_en}
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function showRoutesForStop(stopId) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="bg-white p-4 rounded shadow">Loading routes...</div>';
            
            const matchingRoutes = [];
            for (const route of routesData) {
                for (const direction of ['outbound', 'inbound']) {
                    const res = await fetch(`${API_BASE}route-stop/${route.route}/${direction}/1`);
                    const stops = await res.json();
                    if (stops.data.some(s => s.stop === stopId)) {
                        matchingRoutes.push({route: route.route, direction, dest: isChinese ? route.dest_tc : route.dest_en});
                    }
                }
            }

            resultsDiv.innerHTML = `
                <div class="bg-white p-4 rounded shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">${isChinese ? '巴士站路線' : 'Routes for Stop'}</h3>
                        <button 
                            onclick="closeResults()" 
                            class="text-red-500 hover:text-red-700"
                        >
                            ${isChinese ? '關閉' : 'Close'}
                        </button>
                    </div>
                    ${matchingRoutes.map(r => `
                        <div class="py-2 border-b">
                            <button 
                                onclick="addToDashboard('${r.route}', '${stopId}', '${r.direction}')"
                                class="w-full text-left hover:bg-gray-100 p-2 rounded"
                            >
                                ${r.route} (${r.direction}) - ${r.dest}
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function addToDashboard(route, stopId, direction) {
            selectedStops.push({route, stopId, direction, service_type: 1});
            saveToLocalStorage();
            updateDashboard();
        }

        async function updateDashboard() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            dashboard.setAttribute('draggable', isEditMode.toString());

            for (let i = 0; i < selectedStops.length; i++) {
                const stop = selectedStops[i];
                try {
                    const [etaRes, stopRes] = await Promise.all([
                        fetch(`${API_BASE}eta/${stop.stopId}/${stop.route}/${stop.service_type}`),
                        fetch(`${API_BASE}stop/${stop.stopId}`)
                    ]);
                    const etaData = await etaRes.json();
                    const stopData = await stopRes.json();
                    const stopName = isChinese ? stopData.data.name_tc : stopData.data.name_en;
                    
                    const etas = etaData.data
                        .filter(eta => eta.dir === (stop.direction === 'outbound' ? 'O' : 'I'))
                        .sort((a, b) => new Date(a.eta) - new Date(b.eta))
                        .slice(0, 2);

                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded shadow draggable';
                    card.draggable = isEditMode;
                    card.dataset.index = i;
                    card.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2">
                            ${stop.route} - ${stopName}
                        </h3>
                        <p class="text-gray-600">
                            ${isChinese ? '下班車' : 'Next'}: ${etas[0]?.eta ? new Date(etas[0].eta).toLocaleTimeString() : 'N/A'}
                        </p>
                        <p class="text-gray-600">
                            ${isChinese ? '下下班車' : 'Next+1'}: ${etas[1]?.eta ? new Date(etas[1].eta).toLocaleTimeString() : 'N/A'}
                        </p>
                        ${isEditMode ? `
                            <button 
                                onclick="removeStop('${stop.route}', '${stop.stopId}')" 
                                class="mt-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600"
                            >
                                ${isChinese ? '移除' : 'Remove'}
                            </button>
                        ` : ''}
                    `;
                    dashboard.appendChild(card);
                } catch (error) {
                    console.error('Error updating dashboard:', error);
                }
            }

            if (isEditMode) {
                setupDragAndDrop();
            }
        }

        function removeStop(route, stopId) {
            selectedStops = selectedStops.filter(s => !(s.route === route && s.stopId === stopId));
            saveToLocalStorage();
            updateDashboard();
        }

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.draggable');
            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.index);
                    card.classList.add('opacity-50');
                });

                card.addEventListener('dragend', (e) => {
                    card.classList.remove('opacity-50');
                });

                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                card.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = parseInt(card.dataset.index);
                    
                    const [movedItem] = selectedStops.splice(fromIndex, 1);
                    selectedStops.splice(toIndex, 0, movedItem);
                    saveToLocalStorage();
                    updateDashboard();
                });
            });
        }

        // Profile Management
        function saveToLocalStorage() {
            const profileName = document.getElementById('profileSelect').value;
            const profiles = JSON.parse(localStorage.getItem('busProfiles') || '{}');
            profiles[profileName] = selectedStops;
            localStorage.setItem('busProfiles', JSON.stringify(profiles));
        }

        function loadProfiles() {
            const profiles = JSON.parse(localStorage.getItem('busProfiles') || '{}');
            const select = document.getElementById('profileSelect');
            Object.keys(profiles).forEach(profile => {
                if (profile !== 'default') {
                    const option = document.createElement('option');
                    option.value = profile;
                    option.textContent = profile;
                    select.appendChild(option);
                }
            });
            
            select.addEventListener('change', () => {
                const selectedProfile = select.value;
                selectedStops = profiles[selectedProfile] || [];
                updateDashboard();
            });
        }

        function saveProfile() {
            const name = prompt(isChinese ? '輸入配置文件名稱:' : 'Enter profile name:');
            if (name) {
                const select = document.getElementById('profileSelect');
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
                select.value = name;
                saveToLocalStorage();
            }
        }

        // Sharing
        function shareDashboard() {
            const compactData = selectedStops.map(s => `${s.route}|${s.stopId};${s.direction}-${s.service_type}`).join('_');
            const url = `${window.location.origin}${window.location.pathname}?s=${compactData}`;
            navigator.clipboard.writeText(url);
            alert(isChinese ? '網址已複製到剪貼板！' : 'URL copied to clipboard!');
        }

        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const stopsParam = params.get('s');
            if (stopsParam) {
                selectedStops = stopsParam.split('_').map(item => {
                    const [routePart, rest] = item.split('|');
                    const [stopId, directionService] = rest.split(';');
                    const [direction, service_type] = directionService.split('-');
                    return {route: routePart, stopId, direction, service_type: parseInt(service_type)};
                });
                
                const profiles = JSON.parse(localStorage.getItem('busProfiles') || '{}');
                profiles['Temp'] = selectedStops;
                localStorage.setItem('busProfiles', JSON.stringify(profiles));
                
                const select = document.getElementById('profileSelect');
                const tempOption = Array.from(select.options).find(opt => opt.value === 'Temp');
                if (!tempOption) {
                    const option = document.createElement('option');
                    option.value = 'Temp';
                    option.textContent = '臨時';
                    select.appendChild(option);
                }
                select.value = 'Temp';
                updateDashboard();
            }
        }
    </script>
</body>
</html>
