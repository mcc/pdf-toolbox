<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Day Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        .calculator, .holidays {
            padding: 20px;
        }
        .calculator {
            flex: 2;
        }
        .holidays {
            flex: 1;
            border-left: 1px solid #ccc;
        }
        .checkbox-group {
            margin: 10px 0;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .highlight {
            background-color: #ffff99;
        }
        .holiday-list {
            list-style: none;
            padding: 0;
        }
        .holiday-item {
            margin: 10px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .holiday-date {
            font-weight: bold;
            margin-right: 10px;
        }
        .holiday-weekday {
            color: #666;
            font-style: italic;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <h1>Working Day Calculator</h1>
        
        <div>
            <label>Start Date: <input type="date" id="startDate"></label><br><br>
            <label>End Date: <input type="date" id="endDate"></label><br><br>
            
            <div class="checkbox-group">
                <h3>Exclude Days:</h3>
                <label><input type="checkbox" id="excludeMon"> Monday</label>
                <label><input type="checkbox" id="excludeTue"> Tuesday</label>
                <label><input type="checkbox" id="excludeWed"> Wednesday</label>
                <label><input type="checkbox" id="excludeThu"> Thursday</label>
                <label><input type="checkbox" id="excludeFri"> Friday</label>
                <label><input type="checkbox" id="excludeSat" checked> Saturday</label>
                <label><input type="checkbox" id="excludeSun" checked> Sunday</label>
                <label><input type="checkbox" id="excludeHoliday" checked> Public Holidays</label>
            </div>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <div class="holidays">
        <h2>Public Holidays</h2>
        <ul id="holidayList" class="holiday-list"></ul>
    </div>

    <script src="js/holiday.js"></script>
    <script>
        let holidays = [];
        let maxHolidayYear = 0;
        let dataSource = '';
        const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Fetch and preload holiday data
        async function loadHolidays() {
            try {
                const response = await fetch('https://www.1823.gov.hk/common/ical/tc.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                processHolidayData(data);
                dataSource = 'remote';
            } catch (error) {
                console.error('Error loading remote holidays:', error);
                if (typeof localHolidays !== 'undefined') {
                    processHolidayData(localHolidays);
                    dataSource = 'local';
                    alert('Using local holiday data as remote source is unavailable');
                } else {
                    alert('Failed to load holiday data from both remote and local sources');
                    return;
                }
            }

            // Sort holidays in descending order
            holidays.sort((a, b) => b.date.localeCompare(a.date));

            // Populate holiday list with weekdays
            const holidayList = document.getElementById('holidayList');
            holidayList.innerHTML = holidays.map(h => {
                const date = new Date(h.date.slice(0,4), h.date.slice(4,6) - 1, h.date.slice(6,8));
                const weekday = weekdays[date.getDay()];
                const formattedDate = `${h.date.slice(0,4)}-${h.date.slice(4,6)}-${h.date.slice(6,8)}`;
                return `<li id="holiday-${h.date}" class="holiday-item">
                    <span class="holiday-date">${formattedDate}</span>
                    <span class="holiday-weekday">(${weekday})</span>
                    <span>${h.name}</span>
                </li>`;
            }).join('');
            
            alert(`Holiday information loaded up to year ${maxHolidayYear} from ${dataSource} source`);
            
            // Perform initial calculation after loading holidays
            calculateDays();
        }

        function processHolidayData(data) {
            holidays = data.vcalendar[0].vevent.map(event => ({
                date: event.dtstart[0], // YYYYMMDD format
                name: event.summary
            }));

            holidays.forEach(h => {
                const year = parseInt(h.date.slice(0, 4));
                if (year > maxHolidayYear) maxHolidayYear = year;
            });
        }

        function setDefaultDates() {
            const today = new Date();
            const yearEnd = new Date(today.getFullYear(), 11, 31);
            
            document.getElementById('startDate').value = today.toISOString().slice(0,10);
            document.getElementById('endDate').value = yearEnd.toISOString().slice(0,10);
        }

        function calculateDays() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            const excludeDays = {
                1: document.getElementById('excludeMon').checked,
                2: document.getElementById('excludeTue').checked,
                3: document.getElementById('excludeWed').checked,
                4: document.getElementById('excludeThu').checked,
                5: document.getElementById('excludeFri').checked,
                6: document.getElementById('excludeSat').checked,
                0: document.getElementById('excludeSun').checked
            };
            const excludeHolidays = document.getElementById('excludeHoliday').checked;

            if (!startDate || !endDate || startDate > endDate) {
                document.getElementById('result').style.display = 'none';
                return;
            }

            let workingDays = 0;
            let totalDays = 0;
            let saturdays = 0;
            let sundays = 0;
            let holidaysCount = 0;
            let usedHolidays = new Set();
            let currentDate = new Date(startDate);
            
            // Reset all holiday highlights
            holidays.forEach(h => {
                const el = document.getElementById(`holiday-${h.date}`);
                if (el) el.classList.remove('highlight');
            });

            while (currentDate <= endDate) {
                totalDays++;
                const dayOfWeek = currentDate.getDay();
                const dateStr = currentDate.toISOString().slice(0,10).replace(/-/g, '');
                
                const holiday = holidays.find(h => h.date === dateStr);
                const isHoliday = excludeHolidays && holiday;
                const isExcludedDay = excludeDays[dayOfWeek];
                
                if (dayOfWeek === 6) saturdays++;
                if (dayOfWeek === 0) sundays++;
                if (isHoliday && !excludeDays[dayOfWeek]) holidaysCount++;
                
                if (isHoliday && excludeHolidays) {
                    usedHolidays.add(dateStr);
                    const holidayEl = document.getElementById(`holiday-${dateStr}`);
                    if (holidayEl) holidayEl.classList.add('highlight');
                }
                
                if (!isHoliday && !isExcludedDay) {
                    workingDays++;
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>Result:</h3>
                <p>Period: ${startDate.toDateString()} to ${endDate.toDateString()}</p>
                <p>Total calendar days: ${totalDays}</p>
                <p>Saturdays excluded: ${saturdays}</p>
                <p>Sundays excluded: ${sundays}</p>
                <p>Holidays excluded (excl. Sat/Sun): ${holidaysCount}</p>
                <p><strong>Working days: ${workingDays}</strong></p>
                <p>Note: Holiday data from ${dataSource} source up to ${maxHolidayYear}</p>
            `;
        }

        // Add event listeners for auto-update
        function addEventListeners() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', calculateDays);
            });
        }

        // Initialize
        window.onload = async () => {
            setDefaultDates();
            await loadHolidays(); // Wait for holidays to load before proceeding
            addEventListeners();
        };
    </script>
</body>
</html>